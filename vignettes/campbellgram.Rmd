---
title: "Campbellgram - joint visualisation of copy number and structural variations"
author: "Yilong Li"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Campbellgram - joint visualisation of copy number and structural variations using campbellgrams}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    fig.width=7,
    fig.height=4,
    dpi=300,
    out.width="700px",
    out.height="400px"
)
```

Campbellgram is an R package for visualising *absolute* copy number data and structural variation data jointly in the same plot. The basic premise of the package is that all required inputs of the main function, `campbellgram()`, are standard R data frames.

In addition, `campbellgram()` allows a mutation rainfall plot to be overlaid on top of a campbellgram.

## Plotting campbellgrams

The simplest usage of `campbellgram()` involves plotting nothing but structural variations. In this case, the only required arguments are

* `bedpe` - a data frame of structural variation junctions in [the BEDPE format](https://bedtools.readthedocs.io/en/latest/content/general-usage.html#bedpe-format). Row and column names are ignored. The ID and score columns (columns 7 and 8) are also ignored, although they need to be present in the data frame for it to conform to the BEDPE format.
* `cn_bedgraph` - a data frame of ***absolute copy number data** in [the bedGraph format](https://genome.ucsc.edu/goldenPath/help/bedgraph.html). Row and column names are ignored.
* `chrs_used` - a vector of chromosomes to be visualised, and
* `ref_genome` - a data frame with chromosomes name and chromosome length on its first and second column, respectively.

Data for `ref_genome` can be generated by using [`samtools faidx`](http://www.htslib.org/doc/samtools.html). Alternatively, function `fetchExtendedChromInfoFromUCSC` from package [`GenomeInfoDb`](https://bioconductor.org/packages/release/bioc/html/GenomeInfoDb.html) can be used to fetch the chromosome length data online.

```{r}
library(campbellgram)
data(example_bedpe)
knitr::kable(head(example_bedpe))
data(example_cn)
knitr::kable(head(example_cn))
data(hs37d5_chrom_sizes)
knitr::kable(head(hs37d5_chrom_sizes))
campbellgram(hs37d5_chrom_sizes, example_bedpe, chrs_used = c("7", "12"),
             cn_bedgraph = example_cn)
```

Intra-chromosomal structural variations are shown as one of four different types of arcs. Arcs emanating from the first dashed line are deletion ("+-")-type and tandem duplication ("-+")-type SVs. Arcs emanating from the second dashed line are head-to-head ("\--") and tail-to-tail ("++") type SVs. The default colours of the arcs are taken from `ARC_COLS`.

```{r}
campbellgram::ARC_COLS
```

## Inter vs intra-chromosomal structural variations

In the terminology of `campbellgram()`, structural variation junctions within any chromosome listed in `chrs_used` are considered intra-chromosomal and displayed using arcs. In contrast, inter-chromosomal structural variation breakpoints are indicated using black vertical lines that end in a left or right-leaning hinge for "+" or "-" orientation breakpoints. The mate chromosome of each structural variation breakpoint is indicated above each hinge.

For instance, if the chromosomes 7 and 12 shown above are plotted separately, all the structural variation junctions between chromosomes 7 and 12 will now be displayed as inter-chromosomal translocations.

```{r}
campbellgram(hs37d5_chrom_sizes, example_bedpe, chrs_used = "7",
             cn_bedgraph = example_cn)
campbellgram(hs37d5_chrom_sizes, example_bedpe, chrs_used = "12",
             cn_bedgraph = example_cn)
```

## Zooming

To zoom to a specific region in a chromosome, use parameter `xlim`.

```{r}
campbellgram(hs37d5_chrom_sizes, example_bedpe, chrs_used = "7",
             cn_bedgraph = example_cn, xlim = c(70e6, 100e6))
```

It is also possible to zoom into a chromosome and a chromosomal position while multiple chromosomes are plotted, i.e. when `chrs_used` contains multiple chromosomes. To achieve this, use `chrs_shown` to choose the chromosome to be shown and `xlim` to limit the base pairs further.

```{r}
campbellgram(hs37d5_chrom_sizes, example_bedpe, chrs_used = c("7", "12"),
             cn_bedgraph = example_cn, chrs_shown = "7")
campbellgram(hs37d5_chrom_sizes, example_bedpe, chrs_used = c("7", "12"),
            cn_bedgraph = example_cn, chrs_shown = "7", xlim = c(70e6, 100e6))
```

## Overlaying a rainfall plot

A rainfall plot can be overlaid on top of a campbellgram by using the parameter `muts`, which accepts a data frame of columns in the following order: chromosome, position, base mutated from and base mutated to. The mutations are automatically flipped to the pyrimidine strand, resulting in six possible mutation types.

In `campbellgram()`, inter-mutation distance of a mutation is computed as the harmonic mean of its distances to its adjacent mutations. Since the harmonic mean tends to its smallest data point, the resulting distance is very similar to an alternative approach of just considering each mutation's distance to its next (or previous) mutation. Moreover, by using the harmonic mean approach, the number of mutations in a mutation cluster is correctly shown, as opposed to showing one fewer mutation than there is in a cluster due to the fact that the "last" mutation of the cluster having a large distance it its next mutation.

```{r}
knitr::kable(head(example_mut))
campbellgram(hs37d5_chrom_sizes, example_bedpe, chrs_used = c("7", "12"),
             cn_bedgraph = example_cn, muts = example_mut)
```

See parameter `mut_col` in `?campbellgram` for the default colours used for each of the six mutation types. This parameter can be used to assign a different colour map for the mutation types.

## Copy number segments

So far, the example campbellgrams have been visualised using high resolution copy number data points. In addition to, or in place of, such data, it is also possible to plot copy number segments using the `segments` parameter, which accepts a data frame of copy number segments in BED format.

## Other parameters

The Y-axis range for the copy number and rainfall plot data can be adjusted using parameters `cn_yrange` and `mut_ylim`, respectively.

By default, the input copy number data points (but not copy number segments) are averaged using non-overlapping sliding windows (currently this feature cannot be bypassed). The purpose of this step is to reduce the number of data points to be plotted when the copy number data is of very high density (e.g. 500 bp windows). See `?campbellgram` for the default window sizes used. Parameter `cn_win_size` can be used to manually set the window size to be used and parameter `cn_cex` can be used to control the size of the copy number points.

Parameter `lwd` controls the line width of most of the plotted line segments, including copy number segments and structural variation arcs and line segments.

The plotting of the ideograms is suppressed when less than 10 Mb is shown. Otherwise, the generation of the ideogram can be suppressed using parameter setting `ideogram = FALSE`. The X-axis ticks and labels can be suppressed using `plot_xaxt = FALSE`.
